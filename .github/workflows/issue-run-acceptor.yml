# Copyright (c) 2025 Davi Saranszky Mesquita. All rights reserved.
# See LICENSE for license information.

# Do not use 'workflow_dispatch'

name: Issue Run Acceptor

on:
  issues:
    types: [closed]

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  acceptor:
    name: Running Acceptor
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request == null &&
      contains(github.event.issue.labels.*.name, 'review')

    steps:
      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          export PATH="$HOME/.cursor/bin:$PATH"
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Run Cursor Agent
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          set -euo pipefail
          export PATH="$HOME/.cursor/bin:$PATH"
          git config --local user.email "suporte@ideias.casa"
          git config --local user.name "AI"

          cursor-agent -p --model auto --force --output-format text "You have full access to git, GitHub CLI, and PR operations. You can also run any command you want.
          Work on the issue: $ISSUE_URL
          Read the subject has a tag inside brackets and discover if it's a bug, feature, documentation or command.
          If it's a Feature or Bug: Get pull request associated with the issue and merge it.
          If it's a Command: Do nothing.

          IMPORTANT: Discover the main language on '/README.md' TO OUTPUT ONLY THE FINAL REVIEW IN Markdown to stdout." > review.txt

      - name: Comment on the issue with the review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('review.txt', 'utf8');
            const { owner, repo } = context.repo;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Add 'review' label to the issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: context.issue.number,
                labels: ['review']
              });
              core.info('Added label "review".');
            } catch (error) {
              core.warning('Could not add label "review".');
            }

      - name: Remove label (cleanup)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: context.issue.number,
                name: 'run'
              });
            } catch (error) {}
            try {
            await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: context.issue.number,
                name: 'code'
              });
            } catch (error) {}
            try {
            await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: context.issue.number,
                name: 'working'
              });
            } catch (error) {}
